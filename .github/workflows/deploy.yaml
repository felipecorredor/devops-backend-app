name: Deploy to Railway

on:
  push:
    branches: [main]

env:
  # Nombre por defecto (formato: 'nombre-repo-prod')
  DEFAULT_PROJECT_NAME: "${{ github.repository_name }}-prod"

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Instalar CLI de Railway
      - name: Install Railway CLI
        run: |
          npm install -g @railway/cli || curl -fsSL https://cli.railway.app/install.sh | sh

      # 2. AutenticaciÃ³n
      - name: Login to Railway
        run: railway login --ci-token $RAILWAY_TOKEN
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

      # 3. Definir nombre del proyecto (prioridades: secret > variable > default)
      - name: Set Project Name
        id: set_name
        run: |
          PROJECT_NAME="${{ secrets.RAILWAY_PROJECT_NAME || vars.RAILWAY_PROJECT_NAME || env.DEFAULT_PROJECT_NAME }}"
          echo "PROJECT_NAME=${PROJECT_NAME}" >> $GITHUB_ENV
          echo "::notice::Using project name: ${PROJECT_NAME}"

      # 4. Crear proyecto si no existe
      - name: Setup Project
        run: |
          if ! railway project list | grep -q "$PROJECT_NAME"; then
            railway project create "$PROJECT_NAME"
            echo "::notice::Created new project: $PROJECT_NAME"
          else
            echo "::notice::Using existing project: $PROJECT_NAME"
          fi

      # 5. Desplegar
      - name: Deploy Application
        run: railway up --service fastapi-app --detach
